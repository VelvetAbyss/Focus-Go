name: Release Desktop

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            target: mac
          - os: windows-latest
            target: win
    runs-on: ${{ matrix.os }}
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GH_OWNER: ${{ github.repository_owner }}
      GH_REPO: ${{ github.event.repository.name }}
      APPLE_ID: ${{ secrets.APPLE_ID }}
      APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      CSC_LINK: ${{ secrets.CSC_LINK }}
      CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
      WIN_CSC_LINK: ${{ secrets.WIN_CSC_LINK }}
      WIN_CSC_KEY_PASSWORD: ${{ secrets.WIN_CSC_KEY_PASSWORD }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Check signing secret readiness
        id: signing
        shell: bash
        run: |
          set -euo pipefail
          READY=false
          if [[ "${{ matrix.target }}" == "mac" ]]; then
            if [[ -n "${APPLE_ID:-}" && -n "${APPLE_APP_SPECIFIC_PASSWORD:-}" && -n "${APPLE_TEAM_ID:-}" && -n "${CSC_LINK:-}" && -n "${CSC_KEY_PASSWORD:-}" ]]; then
              READY=true
            fi
          else
            if [[ -n "${WIN_CSC_LINK:-}" && -n "${WIN_CSC_KEY_PASSWORD:-}" ]]; then
              READY=true
            fi
          fi
          echo "ready=${READY}" >> "${GITHUB_OUTPUT}"

      - name: Skip signed release (secrets missing)
        if: steps.signing.outputs.ready != 'true'
        shell: bash
        run: echo "Skipping signed release for ${{ matrix.target }} because required secrets are missing."

      - name: Install dependencies
        if: steps.signing.outputs.ready == 'true'
        run: npm ci

      - name: Run verify gates
        if: steps.signing.outputs.ready == 'true'
        run: npm run verify

      - name: Build desktop distributables
        if: steps.signing.outputs.ready == 'true'
        run: npm run dist --workspace @focus-go/desktop

      - name: Validate mac notarization stapling
        if: matrix.target == 'mac' && steps.signing.outputs.ready == 'true'
        shell: bash
        run: |
          set -euo pipefail
          DMG_PATH=$(find apps/desktop/release -name "*.dmg" | head -n 1)
          [[ -n "${DMG_PATH}" ]] || { echo "No DMG generated" >&2; exit 1; }
          xcrun stapler validate "${DMG_PATH}"

      - name: Validate windows signature
        if: matrix.target == 'win' && steps.signing.outputs.ready == 'true'
        shell: pwsh
        run: |
          $exe = Get-ChildItem -Path "apps/desktop/release" -Recurse -Filter *.exe | Select-Object -First 1
          if (-not $exe) { throw "No EXE generated" }
          $signature = Get-AuthenticodeSignature $exe.FullName
          if ($signature.Status -ne 'Valid') {
            throw "Invalid Authenticode signature status: $($signature.Status)"
          }

      - name: Upload build artifacts
        if: steps.signing.outputs.ready == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: desktop-${{ matrix.target }}
          path: apps/desktop/release/**
